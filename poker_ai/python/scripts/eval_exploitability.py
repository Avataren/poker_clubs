#!/usr/bin/env python3
"""Evaluate approximate exploitability of a checkpoint.

This is a proxy metric: greedy BR policy vs AS policy in heads-up.
Lower is better; values near 0 suggest lower exploitability in this abstraction.
"""

import argparse

from poker_ai.config.hyperparams import NFSPConfig
from poker_ai.training.nfsp import NFSPTrainer


def main():
    parser = argparse.ArgumentParser(description="Evaluate exploitability proxy (BR vs AS)")
    parser.add_argument("checkpoint", help="Path to checkpoint file")
    parser.add_argument("--num-hands", type=int, default=10000, help="Hands to play")
    parser.add_argument("--device", type=str, default="cuda")
    parser.add_argument("--no-amp", action="store_true", help="Disable AMP")
    args = parser.parse_args()

    config = NFSPConfig(
        num_players=2,
        device=args.device,
        use_amp=False if args.no_amp else None,
    )
    trainer = NFSPTrainer(config)
    trainer.load_checkpoint(args.checkpoint)

    print(f"Evaluating exploitability proxy over {args.num_hands} hands...")
    print()

    stats = trainer.eval_exploitability_proxy(num_hands=args.num_hands)
    upper_95 = stats.bb100 + stats.ci95
    lower_95 = stats.bb100 - stats.ci95

    print("Approximate Exploitability Proxy (BR vs AS):")
    print(
        f"  BR advantage: {stats.bb100:+.2f} +/- {stats.ci95:.2f} bb/100 "
        f"(95% CI, n={stats.num_hands})"
    )
    print(f"  95% interval: [{lower_95:+.2f}, {upper_95:+.2f}] bb/100")
    print(
        f"  Seat split: seat0={stats.seat0_bb100:+.2f}, "
        f"seat1={stats.seat1_bb100:+.2f} bb/100"
    )
    print()
    print("Interpretation: lower is better; near 0 indicates lower exploitability.")


if __name__ == "__main__":
    main()
